name: Release Build

on:
  release:
    types: [created]
  workflow_dispatch:  # Allow manual triggering for testing

env:
  JAVA_VERSION: '25'
  GRAALVM_VERSION: '25'

jobs:
  # ==========================================================================
  # Build Platform-Specific JARs with JavaFX natives
  # ==========================================================================
  build-platform-jars:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            platform-alias: win
            artifact-name: jar-windows
          - os: macos-latest
            platform: mac-arm
            platform-alias: mac-arm
            artifact-name: jar-macos-arm64
          - os: macos-15-intel
            platform: mac
            platform-alias: mac
            artifact-name: jar-macos-intel
          - os: ubuntu-latest
            platform: linux
            platform-alias: linux
            artifact-name: jar-linux
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          cli: '1.12.4.1582'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: |
            ${{ runner.os }}-clojure-
      
      - name: Setup Xvfb for Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Build platform-specific uber JAR
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            export DISPLAY=:99
            Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
            sleep 3
          fi
          # Use the platform-alias from matrix
          clojure -T:build uber :platform :${{ matrix.platform-alias }}
          echo "Built JAR for ${{ matrix.platform }} (alias: ${{ matrix.platform-alias }})"
          ls -lh target/
      
      - name: Upload platform JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: target/*-standalone.jar
          retention-days: 7

  # ==========================================================================
  # Build Native Executables (DISABLED - needs fixing)
  # ==========================================================================
  # build-native:
  #   Commented out until JavaFX/GraalVM native-image issues are resolved

  # ==========================================================================
  # Build JPackage Bundled Executables (with JRE and custom icons)
  # ==========================================================================
  build-jpackage:
    needs: build-platform-jars
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows installer with bundled JRE
          - os: windows-latest
            installer-type: msi
            artifact-name: laser-show-windows-jre-msi
            jar-artifact: jar-windows
            icon-file: resources/laser-warning-square.ico
            
          # macOS installer with bundled JRE (ARM64)
          - os: macos-latest
            installer-type: dmg
            artifact-name: laser-show-macos-arm64-jre-dmg
            jar-artifact: jar-macos-arm64
            icon-file: resources/laser-warning-square.icns
            
          # macOS installer with bundled JRE (Intel)
          - os: macos-15-intel
            installer-type: dmg
            artifact-name: laser-show-macos-intel-jre-dmg
            jar-artifact: jar-macos-intel
            icon-file: resources/laser-warning-square.icns
            
          # Linux installer with bundled JRE
          - os: ubuntu-latest
            installer-type: deb
            artifact-name: laser-show-linux-jre-deb
            jar-artifact: jar-linux
            icon-file: resources/laser-warning-square.png

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download platform-specific JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.jar-artifact }}
          path: target/
      
      - name: Setup Java (with jpackage)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Verify icon file exists
        shell: bash
        run: |
          if [ -f "${{ matrix.icon-file }}" ]; then
            echo "✓ Icon file found: ${{ matrix.icon-file }}"
            ls -lh "${{ matrix.icon-file }}"
          else
            echo "✗ Warning: Icon file not found: ${{ matrix.icon-file }}"
            echo "Proceeding without custom icon"
          fi
      
      - name: Prepare JAR for jpackage
        shell: bash
        run: |
          JAR_FILE=$(ls target/*-standalone.jar | head -1)
          JAR_NAME=$(basename "$JAR_FILE")
          echo "JAR_NAME=$JAR_NAME" >> $GITHUB_ENV
          echo "Platform-specific JAR: $JAR_NAME"
      
      - name: Package installer with jpackage
        shell: bash
        run: |
          echo "Creating ${{ matrix.installer-type }} installer with custom icon..."
          
          # Build jpackage arguments
          JPACKAGE_ARGS=(
            --type "${{ matrix.installer-type }}"
            --input target
            --name LaserShow
            --main-jar "$JAR_NAME"
            --main-class laser_show.app
            --dest dist
            --app-version "1.0.0"
            --vendor "LaserShow"
            --description "Laser Show Control Application with bundled JRE"
            --java-options "-Xmx2048m"
            --java-options "-Djavafx.enablePreview=true"
            --java-options "-Djavafx.suppressPreviewWarning=true"
            --java-options "--enable-native-access=ALL-UNNAMED"
            --java-options "-XX:+UseZGC"
            --java-options "-XX:NewRatio=1"
            --verbose
          )
          
          # Add icon if file exists
          if [ -f "${{ matrix.icon-file }}" ]; then
            JPACKAGE_ARGS+=(--icon "${{ matrix.icon-file }}")
            echo "Using custom icon: ${{ matrix.icon-file }}"
          fi
          
          # Add macOS-specific bundle identifier
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            JPACKAGE_ARGS+=(--mac-package-identifier com.zubair.lasershow)
          fi
          
          jpackage "${JPACKAGE_ARGS[@]}"
          
          echo "Installer created:"
          ls -lh dist/
      
      - name: Upload bundled installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: dist/*
          retention-days: 30

  # ==========================================================================
  # Upload Release Assets (COMMENTED OUT - artifacts generated only)
  # ==========================================================================
  # upload-release-assets:
  #   needs: [build-jar, build-native, build-jpackage]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'release'
  #
  #   steps:
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts/
  #
  #     - name: Display artifacts
  #       run: |
  #         echo "Downloaded artifacts:"
  #         find artifacts/ -type f
  #
  #     - name: Create release archives
  #       run: |
  #         cd artifacts
  #
  #         # Package all macOS ARM64 variants (native and compat)
  #         for dir in laser-show-macos-arm64-*; do
  #           if [ -d "$dir" ]; then
  #             echo "Packaging $dir..."
  #             cd "$dir"
  #             chmod +x laser-show 2>/dev/null || true
  #             zip -r "../${dir}.zip" .
  #             cd ..
  #           fi
  #         done
  #
  #         # Package all macOS Intel variants (native and compat)
  #         for dir in laser-show-macos-intel-*; do
  #           if [ -d "$dir" ]; then
  #             echo "Packaging $dir..."
  #             cd "$dir"
  #             chmod +x laser-show 2>/dev/null || true
  #             zip -r "../${dir}.zip" .
  #             cd ..
  #           fi
  #         done
  #
  #         # Package all Windows variants (native and compat)
  #         for dir in laser-show-windows-*; do
  #           if [ -d "$dir" ]; then
  #             echo "Packaging $dir..."
  #             cd "$dir"
  #             zip -r "../${dir}.zip" .
  #             cd ..
  #           fi
  #         done
  #
  #         # Package JAR (unchanged)
  #         if [ -d "uber-jar" ]; then
  #           echo "Packaging uber-jar..."
  #           cd uber-jar
  #           zip -r ../laser-show-jar.zip .
  #           cd ..
  #         fi
  #
  #         echo "Created archives:"
  #         ls -la *.zip || echo "No zip files created"
  #
  #     - name: Upload to release
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         files: |
  #           artifacts/*.zip
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
